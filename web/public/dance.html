<html>
<head>
	<title>dancing to the music</title>
	<style type="text/css">
		body {
			font-family: monospace;
			margin: 10%;
			background: #ffffff;
		}
		audio {
			margin: 20 0 40 0;
		}
	</style>
</head>
<body>
	<script src="/core-client/core-client.js"></script>
	<script src="./jquery-2.0.3.min.js"></script>
	<script src="./dancer.js"></script>

	<h1 id="title">TITLE</h1>
	<h2 id="artist">ARTIST</h2>
	<div id="audiogoeshere"></div>
	<form>
		blink length: <input type="number" id="blinklength" value="75" min="50" max="1000"/> milliseconds
		</p>
		<p>
		beat min length: <input type="number" id="beatminlength" value="75" min="50" max="1000"/> milliseconds
		</p>
		<p>
		kick detect threshold: <input type="number" step=0.01 id="kickdetectthreshold" value="0.4" min="0" max="1"/>
		</p>
		<p>
		kick detect decay: <input type="number" step=0.01 id="kickdetectdecay" value="0.03" min="0" max="1"/>
		</p>
	</form>
	<button id="next">next song</button>


	<script>

	var Core = require('core-client');
	var core = new Core();

	var songs = [
	{
		title: "Footworkin On Air",
		artist: "Traxman",
		src: "http://a.tumblr.com/tumblr_mrkhi0JBKg1sdw5mro1.mp3",
		freqrange: [0, 10],
		blinklength: 75,
		beatminlength: 75,
		kickdetectthreshold: 0.4,
		kickdetectdecay: 0.03,
	},
	{
		title: "EARL",
		artist: "Earl Sweatshirt",
		src: "http://www.controlaltdelight.com/Music/Jangbar/Earl%20Sweatshirt%20-%20Earl.mp3",
		freqrange: [0, 10],
		blinklength: 75,
		beatminlength: 75,
		kickdetectthreshold: 0.4,
		kickdetectdecay: 0.03,
	},
	{
		title: "Xxplosive",
		artist: "Dr. Dre",
		src: "http://a.tumblr.com/tumblr_m1pjvz6aRa1qhil8yo1.mp3",
		freqrange: [0, 10],
		blinklength: 400,
		beatminlength: 400,
		kickdetectthreshold: 0.7,
		kickdetectdecay: 0.02,
	},
	];


	core.on('ready', function() {
		var last = (new Date()).getTime();

	        var blinklength = parseInt($("#blinklength").val());
		var beatminlength = parseInt($("#beatminlength").val());


		//Blinks the light.
		function blink(){
			var now = (new Date()).getTime();
			if (now > last + beatminlength){
				core.motor.devices.a.commands.toggle();
				core.motor.devices.b.commands.toggle();
				core.motor.devices.c.commands.toggle();
				setTimeout(function() {
					core.motor.devices.a.commands.toggle();
					core.motor.devices.b.commands.toggle();
					core.motor.devices.c.commands.toggle();
				}, blinklength);
				last = now;
			}
		}


		//Makes a new audio element for each song
		function change(song) {
			$('#audio').remove(); //remove previous
			var audio = $('<audio id="audio" controls="controls" src="' + song.src + '">').appendTo('#audiogoeshere')[0];

			$("#title").html(song.title);
			$("#artist").html(song.artist);

			blinklength = song.blinklength;
			beatminlength = song.beatminlength;

			var dancer = new Dancer();
			var kick = dancer.createKick({
				frequency: song.freqrange,
				threshold: song.kickdetectthreshold,
				decay: song.kickdetectdecay,
				onKick: blink
			});
			kick.on();
			dancer.load(audio);
			dancer.play();
			window.dancer = dancer;
			window.kick = kick;

			$("#blinklength").val(song.blinklength);
			$("#beatminlength").val(song.beatminlength);
			$("#kickdetectthreshold").val(song.kickdetectthreshold);
			$("#kickdetectdecay").val(song.kickdetectdecay);
		}
		
		//init
		var i = 2;
		change(songs[i]);

		//Gui stuff
		$("#blinklength").on('change', function() {
			blinklength = parseInt($(this).val());
		});
		$("#beatminlength").on('change', function() {
			beatminlength = parseInt($(this).val());
		});
		$("#kickdetectthreshold").on('change', function() {
			kick.threshold = parseFloat($(this).val());
		});
		$("#kickdetectdecay").on('change', function() {
			kick.decay = parseFloat($(this).val());
		});
		$("#next").on('click', function() {
			change(songs[(i + 1) % songs.length]);
			i = (i + 1) % songs.length;
		});
	});

	</script>
</body>
</html>
