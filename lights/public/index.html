<html>
<head>
<title>sean's room</title>
<style type="text/css">

body {
	background: black;
	transition: background-color 0.5s;
	font-family: monospace;
	color: white;
}

#buttons div {
	transition: background-color 0.2s;
	position: fixed;
	width: 23%;
	height: 70%;
	top: 15%;
}

#light0 {
	left: 5%;
}
#light1 {
	left: 38%;
}
#light2 {
	left: 71%;
}
</style>
</head>
<body>
<script src="./jquery-2.0.3.min.js"></script>
<div id="buttons">
	<div id="light0"></div>
	<div id="light1"></div>
	<div id="light2"></div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
	var socket = io.connect("http://localhost");



	var Light = function(id) {
		var id = id;
		var state = 0;
		var $DOMnode = $("#light"+id)

		function changeState(newState) {
			state = newState;
			var color = newState == 1 ? '#ffc000' : '#000000';
			$DOMnode.css({
				"background": color,
			});
			changeBackground();
		}


		this.on = function() {
			var msg = { id: id, command: 'on'};
			socket.emit('command', msg);
			changeState(1);
		}
		this.off = function() {
			var msg = { id: id, command: 'off'};
			socket.emit('command', msg);
			changeState(0);
		}
		this.toggle = function() {
			var msg = { id: id, command: 'toggle'};
			socket.emit('command', msg);
			changeState(state^1);
		}

		this.getState = function() {
			return state;
		}
		this.askState = function() {
			var msg = { id: id, command: 'getState'};
			socket.emit('command', msg);
		}
		this.changeState = changeState;

		$DOMnode.on('click', this.toggle);
		console.log("Light %s initialized!", id);
	};
	var light = [];
	for (var i = 0; i < 3; i ++) {
		light[i] = new Light(i);
		light[i].askState();
	}
	

	//testing
	/*
	setInterval(function() {
		light[Math.floor(Math.random() * 3)].toggle();
	}, 1000);
	*/

	$(document).keypress(function(e) {
		var code = e.keyCode || e.which;
		if (code == 49){
			light[0].toggle();
		}
		if (code == 50){
			light[1].toggle();
		}
		if (code == 51){
			light[2].toggle();
		}
	});

	function changeBackground() {
		if (light.length != 3) return;

		var sum = light[0].getState() + light[1].getState() + light[2].getState();
		var colors = ["#000000", "#333333", "#444444", "#555555"];
		$("body").css({"background": colors[sum]});
	}

	socket.on('message', function (data) {
		try{
			light[data.id].changeState(data.state);
		} catch(e){console.log(e)}
	});
</script>

</script>
</body>
</html>
